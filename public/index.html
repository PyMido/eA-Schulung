<!DOCTYPE html>
<!--
  Pflichtschulung Apotheke – Single-File App (Netlify Identity + localStorage + Quiz + PDF-Zertifikat).
  Stand: 2026-02-27

  Enthält 17 Module (inkl. optionaler Module).
  Fortschritt wird pro Benutzer (E-Mail) im localStorage gespeichert.

  Wichtig:
  - Für "auditfest" (zentraler Nachweis) brauchst du später Serverless Speicherung (Netlify Functions/DB/Blobs).
  - Dieses Setup ist bewusst "leichtgewichtig" und sofort nutzbar.
-->
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pflichtschulung Apotheke</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css">

  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- jsPDF for certificate generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { background-color: #f7fafc; }
    details { border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; background-color: #fff; }
    summary { font-weight: 650; cursor: pointer; display: flex; justify-content: space-between; align-items: center; gap: .75rem; }
    summary::-webkit-details-marker { display:none; }
    .hidden { display: none; }
    .tag { font-size: 0.75rem; padding: .15rem .5rem; border-radius: 999px; border: 1px solid #e2e8f0; }
    .tag-optional { background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .tag-mandatory { background:#eff6ff; border-color:#bfdbfe; color:#1d4ed8; }
    .tag-done { background:#ecfdf5; border-color:#a7f3d0; color:#065f46; }
    .tag-open { background:#f1f5f9; border-color:#e2e8f0; color:#334155; }
    footer { font-size: 0.85rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; color:#334155; }
    .quiz-feedback { font-weight: 600; }
    .muted { color:#64748b; }
  </style>
</head>

<body class="font-sans leading-relaxed antialiased">
  <header class="bg-blue-700 text-white p-4 flex flex-col md:flex-row md:justify-between md:items-center">
    <div class="flex flex-col">
      <h1 class="text-2xl font-bold mb-1">Pflichtschulung Apotheke</h1>
      <span class="text-sm text-blue-100">Interne Selbstschulung (Quiz + Zertifikat)</span>
    </div>

    <!-- Fortschrittsanzeige -->
    <div id="progressWrapper" class="hidden items-center space-x-3 mt-3 md:mt-0">
      <div class="text-right">
        <div id="progressText" class="text-sm font-semibold"></div>
        <div id="userText" class="text-xs text-blue-100"></div>
      </div>
      <div class="w-44 h-2 bg-blue-100 rounded">
        <div id="progressBar" class="h-2 bg-blue-500 rounded" style="width:0%"></div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- Logged-out view -->
    <div id="logged-out" class="bg-white border border-gray-200 rounded-xl p-5">
      <p class="mb-4">Bitte melde dich an, um die Schulungsmodule zu starten.</p>
      <div class="flex flex-wrap gap-2">
        <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Anmelden</button>
        <button id="activateBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Einladung / Zugang aktivieren</button>
      </div>
      <p class="text-sm text-gray-600 mt-3">
        Wenn du eine Einladung erhalten hast, nutze „Einladung / Zugang aktivieren“.
        Falls nichts klickbar wirkt: Adblocker/Tracking-Schutz kurz deaktivieren und neu laden.
      </p>
      <div class="mt-4 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded p-3">
        <b>Hinweis:</b> Diese Schulung ersetzt keine Rechtsberatung. Bei Änderungen interner Abläufe gelten stets die aktuellen SOPs/Anweisungen deiner Apotheke.
      </div>
    </div>

    <!-- Logged-in view -->
    <div id="logged-in" class="hidden">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4 bg-white border border-gray-200 rounded-xl p-4">
        <div>
          <p class="font-semibold">Du bist angemeldet.</p>
          <p class="text-sm text-gray-600">Arbeite die Module durch und schließe jedes Quiz mit mindestens <b>80%</b> ab.</p>
        </div>
        <div class="flex gap-2">
          <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">Fortschritt zurücksetzen</button>
          <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Abmelden</button>
        </div>
      </div>

      <div id="courses" class="space-y-4"></div>

      <!-- Certificate section -->
      <div id="certificateSection" class="hidden mt-6 bg-white border border-gray-200 rounded-xl p-5">
        <h2 class="text-xl font-bold mb-2">Zertifikat</h2>
        <p class="mb-4">Alle aktivierten Module wurden erfolgreich abgeschlossen. Du kannst jetzt dein Zertifikat herunterladen.</p>

        <label class="block mb-2 font-semibold" for="userNameInput">Name für das Zertifikat:</label>
        <input id="userNameInput" type="text" class="border border-gray-300 rounded px-3 py-2 w-full mb-3" placeholder="Vorname Nachname">

        <div class="flex flex-wrap gap-2">
          <button id="downloadCertificateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Zertifikat herunterladen (PDF)</button>
        </div>

        <p class="text-xs text-gray-500 mt-3">
          Tipp: Nutze deinen vollen Namen. Das Zertifikat enthält Datum, Modulanzahl und deine Scores.
        </p>
      </div>
    </div>

    <footer class="mt-8">
      <h2 class="font-semibold mb-2">Rechts-/Themenrahmen (Überblick)</h2>
      <ul class="list-disc pl-6 space-y-1">
        <li><b>ApBetrO</b>: Qualitätsmanagement, Personalunterweisung, Hygieneplan (u.a. §§ 2a, 3, 4a)</li>
        <li><b>ArbSchG</b>: Unterweisung, Erste Hilfe/Brand/Notfallorganisation (u.a. §§ 10, 12)</li>
        <li><b>DGUV</b>: Erste Hilfe/Brandschutz (Umsetzungsvorgaben)</li>
        <li><b>GefStoffV / BioStoffV</b>: Betriebsanweisung, Unterweisung, Schutzmaßnahmen</li>
        <li><b>MPBetreibV</b>: Einweisung/Qualifikation beim Einsatz von Medizinprodukten</li>
        <li><b>JArbSchG</b> (optional): Unterweisung/Schutz bei U18</li>
        <li><b>MuSchG</b>: Gefährdungsbeurteilung, Schutzmaßnahmen, Information/Dokumentation</li>
        <li><b>AGG</b>: Schutz vor Benachteiligung/Belästigung, Maßnahmen/Information</li>
        <li><b>DSGVO</b>: Vertraulichkeit, Datensicherheit, Meldewege bei Datenpannen</li>
        <li><b>EU KI-VO</b> (wenn KI genutzt wird): KI-Kompetenz / verantwortungsvoller Einsatz</li>
        <li><b>IfSG §20c</b> (optional): Impfungen in Apotheken (nur bei Angebot)</li>
        <li><b>BtMG/BtMVV</b> (optional): Opioidsubstitution (nur bei Angebot)</li>
      </ul>
    </footer>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const activateBtn = document.getElementById('activateBtn');
      const resetBtn = document.getElementById('resetBtn');

      const loggedOut = document.getElementById('logged-out');
      const loggedIn = document.getElementById('logged-in');

      const coursesContainer = document.getElementById('courses');

      const certificateSection = document.getElementById('certificateSection');
      const downloadCertificateBtn = document.getElementById('downloadCertificateBtn');
      const userNameInput = document.getElementById('userNameInput');

      const progressWrapper = document.getElementById('progressWrapper');
      const progressText = document.getElementById('progressText');
      const userText = document.getElementById('userText');
      const progressBar = document.getElementById('progressBar');

      // =========================
      // OPTIONAL MODULE SWITCHES
      // =========================
      // Schalte optionale Module nur an, wenn ihr sie in der Apotheke wirklich anbietet.
      const ENABLED = {
        biostoffe: true,      // Bluttests/Abstriche etc.
        jugendliche: false,   // U18 im Betrieb
        impfen: false,        // Impfangebot
        substitution: false,  // Substitution
        ki: true              // KI-Tools im Betrieb
      };

      // =========================
      // COURSE DEFINITIONS (17)
      // =========================
      const allCourses = [
        {
          id: 'hygiene',
          enabled: true,
          optional: false,
          title: 'Modul 1: Hygienemanagement',
          intro: 'Hygiene schützt Patient:innen und Produktqualität – besonders in Rezeptur/Labor.',
          content: `
            <h3 class="text-lg font-semibold mt-3">Kernregeln</h3>
            <ul class="list-disc pl-6">
              <li>Arbeitsflächen vor Beginn reinigen & desinfizieren; nur benötigte Materialien bereitstellen.</li>
              <li>Kein Essen/Trinken in Rezeptur/Labor; nicht über offenen Produkten sprechen/husten/niesen.</li>
              <li>Hände: Waschen + Desinfektion; Handschuhe erst danach anziehen und bei Bedarf wechseln.</li>
              <li>Schutzkleidung: geschlossener Kittel, Haare gebunden/Haube; bei offenem Produkt OP-Maske.</li>
            </ul>
            <h3 class="text-lg font-semibold mt-3">Hygieneplan</h3>
            <p>Der Hygieneplan regelt Reinigung/Desinfektion (Häufigkeit, Mittel, Geräte) und die Dokumentation sowie Regeln zur Schutzkleidung.</p>
          `,
          quiz: [
            { question: 'Warum kein Essen/Trinken in Rezeptur/Labor?', options: ['Kontamination vermeiden', 'Nur Tradition', 'Weil es kalt ist', 'Ist erlaubt'], correctIndex: 0 },
            { question: 'Wann Handschuhe anziehen?', options: ['Vor Händedesinfektion', 'Nach Waschen & Desinfektion', 'Nach dem Etikettieren', 'Nur bei Erkältung'], correctIndex: 1 },
            { question: 'Wozu dient der Hygieneplan?', options: ['Marketing', 'Reinigungs-/Desinfektionsregeln + Dokumentation', 'Kassenabschluss', 'Urlaubsplanung'], correctIndex: 1 },
            { question: 'Was ist bei offenem Produkt sinnvoll?', options: ['Maske tragen', 'Sprechen direkt über Ansatz', 'Schmuck tragen', 'Handschuhe mehrfach verwenden'], correctIndex: 0 },
          ],
        },

        {
          id: 'datenschutz',
          enabled: true,
          optional: false,
          title: 'Modul 2: Datenschutz & Datensicherheit',
          intro: 'Apotheken verarbeiten Gesundheitsdaten. Vertraulichkeit und sichere Prozesse sind Pflicht.',
          content: `
            <h3 class="text-lg font-semibold mt-3">Praxisregeln</h3>
            <ul class="list-disc pl-6">
              <li><b>Need-to-know</b>: Zugriff nur, wenn für die Aufgabe nötig.</li>
              <li>Diskretionszone einhalten; keine sensiblen Informationen laut im Verkaufsraum.</li>
              <li>Keine Patientendaten in private Messenger/Privat-Mail/unsichere Tools übertragen.</li>
              <li>Datenpannen sofort intern melden (z. B. falscher Ausdruck/fehlgeleitete Unterlagen).</li>
              <li>Bildschirm sperren, Passwörter nicht teilen.</li>
            </ul>
          `,
          quiz: [
            { question: 'Was bedeutet Need-to-know?', options: ['Alle dürfen alles sehen', 'Zugriff nur wenn nötig', 'Nur Kund:innen dürfen sehen', 'Nur Chef darf sehen'], correctIndex: 1 },
            { question: 'Was ist eine Datenpanne?', options: ['Falscher Ausdruck liegt offen', 'Kasse stimmt nicht', 'Lieferung verspätet', 'Kunde wartet'], correctIndex: 0 },
            { question: 'Welche Aussage ist richtig?', options: ['Passwort teilen ist ok', 'Bildschirm sperren bei Verlassen', 'Rezepte offen am HV lagern', 'Gesundheitsdaten sind unkritisch'], correctIndex: 1 },
            { question: 'Was ist am HV wichtig?', options: ['Diskretion wahren', 'Alles laut vorlesen', 'Daten auf Zettel an Kunden geben', 'Keine Beratung'], correctIndex: 0 },
          ],
        },

        {
          id: 'qm',
          enabled: true,
          optional: false,
          title: 'Modul 3: Qualitätsmanagement (QM) & Unterweisung',
          intro: 'QM sorgt für sichere Abläufe: SOPs, Dokumentation, Schulung, Selbstinspektionen.',
          content: `
            <h3 class="text-lg font-semibold mt-3">Bausteine eines QM-Systems</h3>
            <ul class="list-disc pl-6">
              <li>SOPs/Arbeitsanweisungen (wer macht was, wie, womit, welche Dokumentation)</li>
              <li>Fehler-/Abweichungsmanagement (melden → Ursache → Maßnahme → Nachweis)</li>
              <li>Selbstinspektionen (läuft es wie beschrieben?)</li>
              <li>Regelmäßige Unterweisungen (bei Start, Änderungen, regelmäßig)</li>
            </ul>
            <p class="mt-3"><b>Merke:</b> Wenn du unsicher bist: SOP nachschlagen oder Apotheker:in fragen – und dokumentieren.</p>
          `,
          quiz: [
            { question: 'Zweck des QM-Systems?', options: ['Nur Lagerhaltung', 'Prozesssicherheit & Patientenschutz', 'Werbung', 'Urlaubsplanung'], correctIndex: 1 },
            { question: 'Was ist eine SOP?', options: ['Gerücht', 'Arbeitsanweisung mit Dokumentationspunkten', 'Kassenbon', 'Chatverlauf'], correctIndex: 1 },
            { question: 'Was tun bei Abweichung?', options: ['Ignorieren', 'Melden & dokumentieren', 'Warten bis Jahresende', 'Nur Kolleg:innen erzählen'], correctIndex: 1 },
            { question: 'Selbstinspektion bedeutet?', options: ['Preisvergleich', 'Prozessprüfung intern', 'Nur Putzen', 'Kundenumfrage'], correctIndex: 1 },
          ],
        },

        {
          id: 'herstellung',
          enabled: true,
          optional: false,
          title: 'Modul 4: Herstellung, Prüfung, Lagerung, Verblistern/Stellen',
          intro: 'Hohe Relevanz für Arzneimittelsicherheit (Verwechslung, Dosierung, Lagerbedingungen).',
          content: `
            <h3 class="text-lg font-semibold mt-3">Herstellung</h3>
            <ul class="list-disc pl-6">
              <li>Nach SOP arbeiten, Plausibilität prüfen, korrekt abwiegen/messen.</li>
              <li>Etikett (Wirkstoff, Stärke, Haltbarkeit, Lagerung, Charge) + Herstellprotokoll.</li>
            </ul>
            <h3 class="text-lg font-semibold mt-3">Lagerung</h3>
            <ul class="list-disc pl-6">
              <li>Kühlware: Temperaturüberwachung + Maßnahmen bei Abweichung.</li>
              <li>FIFO/Verfallkontrolle; Licht/Feuchte beachten.</li>
            </ul>
            <h3 class="text-lg font-semibold mt-3">Verblistern/Stellen</h3>
            <ul class="list-disc pl-6">
              <li>4-Augen-Prinzip, Medikationsplan-Abgleich, eindeutige Patientenzuordnung, Dokumentation.</li>
            </ul>
          `,
          quiz: [
            { question: 'Was ist bei Rezeptur immer Pflicht?', options: ['Ohne Protokoll', 'Nach SOP + dokumentieren', 'Ohne Etikett', 'Ohne Kontrolle'], correctIndex: 1 },
            { question: 'Warum Kühlschrank-Temperatur dokumentieren?', options: ['Deko', 'Qualität/Kühlkette nachweisen', 'Nur für Kunden', 'Nur im Notdienst'], correctIndex: 1 },
            { question: 'FIFO bedeutet?', options: ['First In First Out', 'Fast In Fast Out', 'Free In Free Out', 'First In Fix Out'], correctIndex: 0 },
            { question: 'Beim Verblistern wichtig:', options: ['Schnell sein', '4-Augen + Patientenzuordnung', 'Ohne Plan arbeiten', 'Keine Doku'], correctIndex: 1 },
          ],
        },

        {
          id: 'arbeitsschutz',
          enabled: true,
          optional: false,
          title: 'Modul 5: Arbeitsschutz-Unterweisung',
          intro: 'Sicherheit im Betrieb: Gefährdungen erkennen, PSA nutzen, Unfälle melden.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Wege frei halten, Kartons/Leitern sicher lagern.</li>
              <li>PSA nutzen (Handschuhe/Brille je nach Tätigkeit).</li>
              <li>Beinahe-Unfälle melden → Prävention.</li>
              <li>Erste Hilfe im Verbandbuch dokumentieren.</li>
            </ul>
          `,
          quiz: [
            { question: 'Unterweisung erfolgt…', options: ['nur bei Notdienst', 'bei Start, Änderungen, regelmäßig', 'nur bei Inventur', 'nie'], correctIndex: 1 },
            { question: 'Beinahe-Unfall?', options: ['ignorieren', 'melden & analysieren', 'nur privat notieren', 'nur Kunden informieren'], correctIndex: 1 },
            { question: 'Was gehört dazu?', options: ['Fluchtwege zustellen', 'Ordnung + PSA', 'Geräte ohne Einweisung', 'keine Pausen'], correctIndex: 1 },
            { question: 'Erste Hilfe dokumentieren in…', options: ['Kassenbuch', 'Verbandbuch', 'Rezepturprotokoll', 'Telefonliste'], correctIndex: 1 },
          ],
        },

        {
          id: 'brandschutz',
          enabled: true,
          optional: false,
          title: 'Modul 6: Brandschutz',
          intro: 'Brand verhindern, korrekt alarmieren, evakuieren, Löschmittel kennen.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Erster Schritt: Alarmieren (Feuermelder/112) – dann Evakuierung.</li>
              <li>Fluchtwege/Notausgänge frei halten.</li>
              <li>Feuerlöscher: Standort kennen, nur Entstehungsbrand und ohne Eigengefährdung.</li>
              <li>Aufzug im Brandfall nicht benutzen.</li>
            </ul>
          `,
          quiz: [
            { question: 'Erster Schritt bei Brand?', options: ['Filmen', 'Alarmieren', 'Aufräumen', 'Ignorieren'], correctIndex: 1 },
            { question: 'Fluchtwege müssen…', options: ['zugestellt sein', 'frei sein', 'nur im Sommer frei', 'nur im Notdienst frei'], correctIndex: 1 },
            { question: 'Aufzug im Brandfall?', options: ['immer nutzen', 'nicht nutzen', 'nur mit Chef', 'egal'], correctIndex: 1 },
            { question: 'Feuerlöscher nutzen…', options: ['bei jedem Brand allein', 'nur Entstehungsbrand ohne Eigengefährdung', 'nie', 'nur Kund:innen'], correctIndex: 1 },
          ],
        },

        {
          id: 'erstehilfe',
          enabled: true,
          optional: false,
          title: 'Modul 7: Erste Hilfe',
          intro: 'Notfallkette, grundlegende Maßnahmen, Standorte von Verbandsmaterial kennen.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Eigenschutz → Überblick → Notruf (Wo/Was/Wieviele/Welche Verletzung).</li>
              <li>Bewusstlos + atmet → stabile Seitenlage.</li>
              <li>Keine Atmung → HLW beginnen; AED nutzen, wenn vorhanden.</li>
              <li>Dokumentation im Verbandbuch.</li>
            </ul>
          `,
          quiz: [
            { question: 'Notruf: was ist wichtig?', options: ['Lieblingsfarbe', 'Wo/Was/Wieviele/Verletzung', 'Wetter', 'Öffnungszeiten'], correctIndex: 1 },
            { question: 'Bewusstlos, atmet?', options: ['Sitzen lassen', 'Stabile Seitenlage', 'Essen geben', 'Spazieren'], correctIndex: 1 },
            { question: 'Keine Atmung?', options: ['Warten', 'HLW starten', 'Wasser geben', 'Nur Arzt rufen ohne Maßnahmen'], correctIndex: 1 },
            { question: 'Dokumentation?', options: ['Verbandbuch', 'Wareneingang', 'Preisschild', 'Dienstplan'], correctIndex: 0 },
          ],
        },

        {
          id: 'gefahrstoffe',
          enabled: true,
          optional: false,
          title: 'Modul 8: Gefahrstoffe (Desinfektion/Chemikalien)',
          intro: 'Betriebsanweisung, Schutzmaßnahmen, Lagerung und Notfallverhalten.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Kennzeichnung verstehen (Piktogramme/H-/P-Sätze).</li>
              <li>PSA: Handschuhe/Brille je nach Stoff.</li>
              <li>Verschütten: Bereich sichern, gemäß SOP aufnehmen, korrekt entsorgen.</li>
              <li>Augenkontakt: sofort spülen, melden, ärztlich abklären.</li>
            </ul>
          `,
          quiz: [
            { question: 'Betriebsanweisung muss…', options: ['nur mündlich', 'schriftlich + Unterweisung', 'geheim bleiben', 'nur Chef kennen'], correctIndex: 1 },
            { question: 'Augenkontakt ätzend?', options: ['abwarten', 'sofort spülen + melden', 'Pflaster', 'Alkohol drauf'], correctIndex: 1 },
            { question: 'H-/P-Sätze?', options: ['Deko', 'Gefahr/Schutzmaßnahmen', 'Preis', 'Lagerort'], correctIndex: 1 },
            { question: 'Verschüttung?', options: ['in Abfluss', 'SOP/Bindemittel/Entsorgung', 'ignorieren', 'nur lüften'], correctIndex: 1 },
          ],
        },

        {
          id: 'biostoffe',
          enabled: ENABLED.biostoffe,
          optional: true,
          title: 'Modul 9: Biostoffe / Bluttests / Abstriche (optional)',
          intro: 'Nur relevant, wenn ihr Bluttests/Abstriche oder vergleichbare Tätigkeiten anbietet.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Einmalhandschuhe; sichere Entsorgung (stichfeste Behälter).</li>
              <li>Kein Recapping; keine Lanzetten im normalen Müll.</li>
              <li>Stichverletzung: reinigen/desinfizieren, melden, medizinisch abklären.</li>
              <li>Flächen nach Kontakt desinfizieren.</li>
            </ul>
          `,
          quiz: [
            { question: 'Lanzetten entsorgen in…', options: ['Papiermüll', 'stichfest', 'Ausguss', 'Tasche'], correctIndex: 1 },
            { question: 'Stichverletzung?', options: ['ignorieren', 'desinfizieren + melden + abklären', 'nur Pflaster', 'morgen schauen'], correctIndex: 1 },
            { question: 'PSA beim Blutkontakt?', options: ['keine', 'Handschuhe', 'Schal', 'offene Wunde'], correctIndex: 1 },
            { question: 'Nach Kontakt?', options: ['nichts', 'Fläche desinfizieren', 'nur lüften', 'nur Hände waschen ohne Desinfektion'], correctIndex: 1 },
          ],
        },

        {
          id: 'medizinprodukte',
          enabled: true,
          optional: false,
          title: 'Modul 10: Medizinprodukte & Geräteeinweisung',
          intro: 'Geräte (BD/BZ etc.) nur nach Einweisung nutzen – Dokumentation nicht vergessen.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Nur eingewiesene Personen bedienen Geräte.</li>
              <li>Einweisung dokumentieren (Datum, Gerät, Person).</li>
              <li>Funktionskontrolle/Wartung nach Vorgaben.</li>
              <li>Bei Updates/Änderungen ggf. erneut einweisen.</li>
            </ul>
          `,
          quiz: [
            { question: 'Wer darf ein Medizinprodukt bedienen?', options: ['Jede Person', 'Nur eingewiesene Personen', 'Nur Kund:innen', 'Nur Azubis'], correctIndex: 1 },
            { question: 'Einweisung dokumentieren?', options: ['nein', 'ja', 'nur mündlich', 'nur WhatsApp'], correctIndex: 1 },
            { question: 'Wann neue Einweisung?', options: ['nie', 'bei relevanten Updates/Änderungen', 'nur Weihnachten', 'nur Inventur'], correctIndex: 1 },
            { question: 'Vor Nutzung prüfen?', options: ['Optik', 'Funktionsfähigkeit/Zustand', 'nur Akku', 'nichts'], correctIndex: 1 },
          ],
        },

        {
          id: 'lasten',
          enabled: true,
          optional: false,
          title: 'Modul 11: Ergonomie & Lastenhandhabung (Heben/Tragen)',
          intro: 'Rückenschonendes Arbeiten reduziert Ausfälle und Verletzungen.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Last nah am Körper, aus den Beinen heben, nicht verdrehen.</li>
              <li>Hilfsmittel nutzen (Wagen), schwere Lasten zu zweit.</li>
              <li>Wege frei halten; rutschfeste Schuhe.</li>
            </ul>
          `,
          quiz: [
            { question: 'Richtiges Heben?', options: ['Rücken rund', 'Aus Beinen, Last nah', 'Ruckartig', 'Einarmig'], correctIndex: 1 },
            { question: 'Schwere Last?', options: ['allein', 'zu zweit/Hilfsmittel', 'werfen', 'springen'], correctIndex: 1 },
            { question: 'No-Go?', options: ['Wagen nutzen', 'Drehen mit Last', 'Wege frei', 'Pausen'], correctIndex: 1 },
            { question: 'Ziel?', options: ['Zeit sparen', 'Gesundheit schützen', 'nur Fitness', 'nur Lager'], correctIndex: 1 },
          ],
        },

        {
          id: 'jugendliche',
          enabled: ENABLED.jugendliche,
          optional: true,
          title: 'Modul 12: Jugendarbeitsschutz (optional)',
          intro: 'Nur relevant bei Beschäftigung von Jugendlichen (U18).',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Unterweisung vor Beginn und regelmäßig; altersgerecht.</li>
              <li>Gefährliche Tätigkeiten sind eingeschränkt/unzulässig.</li>
              <li>Arbeitszeiten und Pausen beachten.</li>
              <li>Dokumentation der Unterweisung.</li>
            </ul>
          `,
          quiz: [
            { question: 'Gilt nur wenn…', options: ['alle über 30', 'U18 beschäftigt', 'nur Chef da', 'Notdienst'], correctIndex: 1 },
            { question: 'Grundprinzip?', options: ['keine Regeln', 'Schutz/Unterweisung', 'nur Umsatz', 'nur Kasse'], correctIndex: 1 },
            { question: 'Gefährliche Tätigkeiten?', options: ['immer ok', 'eingeschränkt/unzulässig', 'egal', 'nur nachts'], correctIndex: 1 },
            { question: 'Dokumentation?', options: ['unwichtig', 'wichtig', 'nur mündlich', 'nur privat'], correctIndex: 1 },
          ],
        },

        {
          id: 'mutterschutz',
          enabled: true,
          optional: false,
          title: 'Modul 13: Mutterschutz',
          intro: 'Schutz für Schwangere/Stillende: Gefährdungen bewerten und Maßnahmen umsetzen.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Gefährdungsbeurteilung: z. B. Gefahrstoffe, Biostoffe, schwere Lasten.</li>
              <li>Arbeitsplatz anpassen / Tätigkeiten ändern.</li>
              <li>Information + Dokumentation der Maßnahmen.</li>
            </ul>
          `,
          quiz: [
            { question: 'Was ist zentral?', options: ['Ignorieren', 'Gefährdungsbeurteilung + Maßnahmen', 'Kündigung', 'Mehr Überstunden'], correctIndex: 1 },
            { question: 'Beispiel Risiko?', options: ['Pause', 'Gefahrstoffe/Lasten', 'Telefon', 'PC'], correctIndex: 1 },
            { question: 'Maßnahmen?', options: ['keine', 'Arbeitsplatz anpassen', 'nur Urlaub', 'nur Notdienst'], correctIndex: 1 },
            { question: 'Dokumentation?', options: ['optional', 'erforderlich', 'verboten', 'nur mündlich'], correctIndex: 1 },
          ],
        },

        {
          id: 'agg',
          enabled: true,
          optional: false,
          title: 'Modul 14: AGG / Anti-Diskriminierung',
          intro: 'Respektvoller Umgang, keine Benachteiligung/Belästigung, klare Meldewege.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Keine Diskriminierung nach z. B. Herkunft, Geschlecht, Alter, Religion etc.</li>
              <li>Belästigung/sexuelle Belästigung ist verboten.</li>
              <li>Vorfälle melden (interner Prozess).</li>
            </ul>
          `,
          quiz: [
            { question: 'AGG schützt vor…', options: ['Schuhgröße', 'Benachteiligung nach Merkmalen', 'Lieblingsfilm', 'Hobby'], correctIndex: 1 },
            { question: 'Belästigung ist…', options: ['immer ok', 'unerwünscht + würdverletzend', 'nur privat', 'nur Humor'], correctIndex: 1 },
            { question: 'Bei Vorfall?', options: ['schweigen', 'melden', 'online posten', 'Kunden fragen'], correctIndex: 1 },
            { question: 'Ziel?', options: ['Angst', 'faires Betriebsklima', 'mehr Streit', 'keine Regeln'], correctIndex: 1 },
          ],
        },

        {
          id: 'ki',
          enabled: ENABLED.ki,
          optional: true,
          title: 'Modul 15: KI-Nutzung & KI-Kompetenz (optional)',
          intro: 'Wenn KI-Tools genutzt werden: Ergebnisse prüfen, keine Patientendaten in offene Systeme.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>KI-Ausgaben fachlich prüfen (Fehler/Halluzinationen möglich).</li>
              <li>Keine Patientendaten in offene KI-Chats eingeben.</li>
              <li>Human-in-the-loop: Verantwortung bleibt beim Menschen.</li>
            </ul>
          `,
          quiz: [
            { question: 'KI-Ergebnis in Beratung…', options: ['immer korrekt', 'prüfen & validieren', 'ungeprüft weitergeben', 'nur kopieren'], correctIndex: 1 },
            { question: 'Patientendaten in KI-Chat?', options: ['immer ok', 'nur in freigegebenen Systemen', 'per WhatsApp', 'egal'], correctIndex: 1 },
            { question: 'Human-in-the-loop?', options: ['KI entscheidet allein', 'Mensch behält Kontrolle', 'niemand haftet', 'nur IT'], correctIndex: 1 },
            { question: 'Warum schulen?', options: ['Spaß', 'Risiken minimieren', 'Urlaub', 'Marketing'], correctIndex: 1 },
          ],
        },

        {
          id: 'impfen',
          enabled: ENABLED.impfen,
          optional: true,
          title: 'Modul 16: Impfungen in der Apotheke (optional)',
          intro: 'Nur relevant, wenn ihr Impfungen anbietet.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Nur qualifizierte Apotheker:innen nach Schulung durchführen.</li>
              <li>Anamnese + Aufklärung + Einwilligung.</li>
              <li>Notfallmanagement (z. B. Anaphylaxie) kennen.</li>
              <li>Dokumentation (Impfstoff/Charge/Datum).</li>
            </ul>
          `,
          quiz: [
            { question: 'Voraussetzung?', options: ['PKA darf', 'Apotheker:in mit Schulung', 'Kunde entscheidet', 'Botendienst'], correctIndex: 1 },
            { question: 'Vor Impfung?', options: ['keine Prüfung', 'Anamnese + Einwilligung', 'nur Preis', 'nur Termin'], correctIndex: 1 },
            { question: 'Nach Impfung?', options: ['sofort weg ohne Hinweis', 'kurze Nachbeobachtung', 'Sport sofort', 'Alkohol empfehlen'], correctIndex: 1 },
            { question: 'Dokumentation?', options: ['nichts', 'Charge/Datum etc.', 'nur Name', 'nur Uhrzeit'], correctIndex: 1 },
          ],
        },

        {
          id: 'substitution',
          enabled: ENABLED.substitution,
          optional: true,
          title: 'Modul 17: Opioidsubstitution (optional)',
          intro: 'Nur relevant, wenn eure Apotheke Substitutionsmittel abgibt.',
          content: `
            <ul class="list-disc pl-6 mt-2">
              <li>Strenge Dokumentation (BtM-Buch/Abgabeprotokolle).</li>
              <li>Identitätsprüfung/Abgabeprozesse (Sichtbezug vs. Take-Home).</li>
              <li>Diskretion + Datenschutz.</li>
            </ul>
          `,
          quiz: [
            { question: 'Wer darf abgeben?', options: ['jeder', 'pharmazeutisches Personal', 'Kund:innen', 'Lieferanten'], correctIndex: 1 },
            { question: 'Wichtigstes No-Go?', options: ['diskrete Abgabe', 'fehlende Dokumentation', 'Beratung', 'Identitätsprüfung'], correctIndex: 1 },
            { question: 'Diskretion wichtig wegen…', options: ['Mode', 'Privatsphäre/Datenschutz', 'schneller', 'egal'], correctIndex: 1 },
            { question: 'Take-Home bedeutet…', options: ['nur Sichtbezug', 'Abgabe für mehrere Tage nach Vorgaben', 'Versand', 'Rezept per Foto'], correctIndex: 1 },
          ],
        },
      ];

      const courses = allCourses.filter(c => c.enabled);

      // =========================
      // STORAGE (per user)
      // =========================
      function getUserEmail() {
        try {
          const u = window.netlifyIdentity ? netlifyIdentity.currentUser() : null;
          return u?.email || '';
        } catch { return ''; }
      }

      function storageKey() {
        const email = getUserEmail();
        return email ? `apothekeProgress:${email}` : 'apothekeProgress';
      }

      function loadProgress() {
        const raw = localStorage.getItem(storageKey());
        const obj = raw ? JSON.parse(raw) : {};
        // init missing
        courses.forEach(c => {
          if (!obj[c.id]) obj[c.id] = { completed: false, score: 0, lastAt: null };
        });
        return obj;
      }

      function saveProgress(p) {
        localStorage.setItem(storageKey(), JSON.stringify(p));
      }

      let progress = loadProgress();

      // =========================
      // UI helpers
      // =========================
      function updateProgressDisplay() {
        const total = courses.length;
        const completed = courses.filter(c => progress[c.id]?.completed).length;
        progressText.textContent = `${completed}/${total} Module abgeschlossen`;
        const percentage = total ? (completed / total) * 100 : 0;
        progressBar.style.width = percentage + '%';

        const email = getUserEmail();
        userText.textContent = email ? `User: ${email}` : '';
      }

      function updateCertificateVisibility() {
        const allCompleted = courses.length > 0 && courses.every(c => progress[c.id]?.completed);
        if (allCompleted) certificateSection.classList.remove('hidden');
        else certificateSection.classList.add('hidden');
      }

      function badgeHtml(course) {
        const done = progress[course.id]?.completed;
        const base = done ? 'tag tag-done' : 'tag tag-open';
        const opt = course.optional ? 'tag tag-optional' : 'tag tag-mandatory';
        const optText = course.optional ? 'Optional' : 'Pflicht';
        const doneText = done ? `Abgeschlossen (${progress[course.id].score}%)` : 'Offen';
        return `
          <div class="flex items-center gap-2 flex-wrap">
            <span class="${opt}">${optText}</span>
            <span class="${base}">${doneText}</span>
          </div>
        `;
      }

      function renderCourses() {
        coursesContainer.innerHTML = '';

        courses.forEach(course => {
          const done = !!progress[course.id]?.completed;

          const details = document.createElement('details');
          details.className = 'course';
          details.open = !done;

          const summary = document.createElement('summary');
          summary.innerHTML = `
            <span>${course.title}</span>
            ${badgeHtml(course)}
          `;
          details.appendChild(summary);

          const contentDiv = document.createElement('div');
          contentDiv.className = 'mt-3 space-y-3';
          contentDiv.innerHTML = `
            <p class="text-gray-700">${course.intro}</p>
            <div class="prose max-w-none">${course.content}</div>

            <div class="quiz mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <div class="flex items-start justify-between gap-4 flex-wrap">
                <h4 class="font-semibold">Quiz</h4>
                <div class="text-sm muted">Bestehen ab <b>80%</b></div>
              </div>

              ${course.quiz.map((q, qi) => `
                <div class="quiz-question mt-4">
                  <p class="font-semibold">${qi + 1}. ${q.question}</p>
                  <div class="mt-2 space-y-1">
                    ${q.options.map((opt, oi) => `
                      <label class="block">
                        <input type="radio" name="${course.id}-q${qi}" value="${oi}" class="mr-2"> ${opt}
                      </label>
                    `).join('')}
                  </div>
                </div>
              `).join('')}

              <div class="mt-4 flex flex-wrap gap-2 items-center">
                <button class="submit-quiz bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" data-course="${course.id}">
                  Quiz abschließen
                </button>
                <span class="text-sm muted">Tipp: Wenn du weniger als 80% hast, korrigiere deine Antworten und versuche es erneut.</span>
              </div>

              <p class="quiz-feedback text-sm mt-3"></p>
            </div>
          `;

          details.appendChild(contentDiv);
          coursesContainer.appendChild(details);
        });

        // Attach listeners
        document.querySelectorAll('.submit-quiz').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const courseId = e.target.dataset.course;
            const course = courses.find(c => c.id === courseId);
            const feedbackEl = e.target.closest('.quiz').querySelector('.quiz-feedback');

            let score = 0;
            course.quiz.forEach((q, qi) => {
              const selected = document.querySelector(`input[name="${courseId}-q${qi}"]:checked`);
              if (selected && parseInt(selected.value, 10) === q.correctIndex) score++;
            });

            const percentage = Math.round((score / course.quiz.length) * 100);

            if (percentage >= 80) {
              progress[courseId].completed = true;
              progress[courseId].score = percentage;
              progress[courseId].lastAt = new Date().toISOString();

              feedbackEl.textContent = `Bestanden: ${percentage}% ✅`;
              feedbackEl.className = 'quiz-feedback text-green-700';

              saveProgress(progress);
              renderCourses();
              updateProgressDisplay();
              updateCertificateVisibility();
            } else {
              feedbackEl.textContent = `Leider nur ${percentage}%. Du benötigst mindestens 80%.`;
              feedbackEl.className = 'quiz-feedback text-red-700';
            }
          });
        });
      }

      function updateUI() {
        const user = window.netlifyIdentity ? netlifyIdentity.currentUser() : null;
        if (user) {
          loggedOut.classList.add('hidden');
          loggedIn.classList.remove('hidden');
          progressWrapper.classList.remove('hidden');

          // reload progress using email-based key
          progress = loadProgress();

          renderCourses();
          updateProgressDisplay();
          updateCertificateVisibility();
        } else {
          loggedOut.classList.remove('hidden');
          loggedIn.classList.add('hidden');
          progressWrapper.classList.add('hidden');
          certificateSection.classList.add('hidden');
        }
      }

      // =========================
      // Netlify Identity: invite/login robustness
      // =========================
      function hasTokenHash() {
        const h = window.location.hash || '';
        return h.includes('invite_token=') || h.includes('confirmation_token=') || h.includes('recovery_token=');
      }

      if (window.netlifyIdentity) {
        netlifyIdentity.on('init', () => {
          updateUI();
          // If user arrived via invite/recovery link, open widget automatically
          if (!netlifyIdentity.currentUser() && hasTokenHash()) {
            setTimeout(() => netlifyIdentity.open(), 250);
          }
        });

        netlifyIdentity.on('login', () => {
          netlifyIdentity.close();
          // Clear token hash to avoid loops
          try { window.location.hash = ''; } catch {}
          updateUI();
        });

        netlifyIdentity.on('logout', () => {
          updateUI();
        });

        netlifyIdentity.init();
      }

      loginBtn?.addEventListener('click', () => netlifyIdentity.open('login'));
      activateBtn?.addEventListener('click', () => netlifyIdentity.open('signup'));
      logoutBtn?.addEventListener('click', () => netlifyIdentity.logout());

      resetBtn?.addEventListener('click', () => {
        if (!confirm('Fortschritt für diesen Benutzer wirklich zurücksetzen?')) return;
        localStorage.removeItem(storageKey());
        progress = loadProgress();
        renderCourses();
        updateProgressDisplay();
        updateCertificateVisibility();
      });

      // =========================
      // Certificate generation (jsPDF)
      // =========================
      downloadCertificateBtn?.addEventListener('click', () => {
        const name = userNameInput.value.trim();
        if (!name) {
          alert('Bitte gib deinen Namen ein.');
          return;
        }
        const email = getUserEmail();
        if (!email) {
          alert('Kein Benutzer erkannt. Bitte neu einloggen.');
          return;
        }

        // Ensure all modules passed
        const allCompleted = courses.length > 0 && courses.every(c => progress[c.id]?.completed);
        if (!allCompleted) {
          alert('Noch nicht alle Module abgeschlossen.');
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });

        // Header
        doc.setFontSize(30);
        doc.text('Zertifikat', 148, 28, { align: 'center' });

        doc.setFontSize(14);
        doc.text('Pflichtschulung öffentliche Apotheke (intern)', 148, 38, { align: 'center' });

        // Person
        doc.setFontSize(16);
        doc.text('Hiermit wird bestätigt, dass', 148, 55, { align: 'center' });

        doc.setFontSize(22);
        doc.text(name, 148, 68, { align: 'center' });

        doc.setFontSize(12);
        doc.text(`E-Mail: ${email}`, 148, 78, { align: 'center' });

        // Modules summary
        doc.setFontSize(12);
        doc.text(`Abgeschlossene Module: ${courses.length}`, 148, 92, { align: 'center' });

        // List modules and scores (2 columns)
        const leftX = 25;
        const rightX = 155;
        let yLeft = 105;
        let yRight = 105;

        const rows = courses.map((c, idx) => {
          const score = progress[c.id]?.score ?? 0;
          const label = c.title.replace(/<[^>]*>/g,''); // strip html
          return `${idx+1}. ${label} — ${score}%`;
        });

        rows.forEach((line, i) => {
          if (i < Math.ceil(rows.length/2)) {
            doc.text(line, leftX, yLeft);
            yLeft += 7;
          } else {
            doc.text(line, rightX, yRight);
            yRight += 7;
          }
        });

        const dateStr = new Date().toLocaleDateString('de-DE');
        doc.setFontSize(12);
        doc.text(`Ausgestellt am: ${dateStr}`, 148, 190, { align: 'center' });

        doc.setFontSize(10);
        doc.text('Hinweis: Dieses Zertifikat dokumentiert eine interne Selbstschulung (Quiz-basiert).', 148, 198, { align: 'center' });

        doc.save(`Zertifikat_${name.replace(/\s+/g,'_')}.pdf`);
      });

      // Initial UI
      updateUI();
    });
  </script>
</body>
</html>
